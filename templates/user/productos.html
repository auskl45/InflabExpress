{% extends "base.html" %}
{% block content %}
<div class="row mb-4" >
    {%for row in productos%}
    <div class="card mr-5 mt-4" style="width: 18rem;">
        <img class="card-img-top " style="height: 16rem;" src="https://images.photowall.com/products/54675/surfboard.jpg?h=699&q=85" alt="Card image cap">
        <div class="card-body"  >
          <h5 class="card-title">{{row.nombreProducto}}</h5>
          <p class="text-danger">!Solo quedan {{row.cantidad}}!</p>

          <div class="row container">
            <p class="card-text mr-2">{{row.marca}} </p>|
            <p class="ml-2">MXN ${{row.precio}}</p>
          </div>
          <div class="row ">
          <button class="btn text-white btn-warning ml-3 col-4" onclick="agregarCanasta('{{row.id}}','{{row.nombreProducto}}','{{row.cantidad}}')" id="btnAdd"><i class="bi bi-cart-dash"></i> añadir</button>
        </div>
        </div>
      </div>
    {%endfor%}
    </div>
    <script>
$(document).ready(function(){
 });
 //SOLUCIONAR ERROR PONER LIMITE A LA CANTIDAD DE PRODUCTOS AÑADIDOS
 var cantidadAñadido=0;
 var carrito=[];
 function agregarCanasta(id,nombreProducto,cantidad){
  const popUpCarrito = document.getElementById("popUpCarrito");
var content = '';
  // if(cantidadAñadido<cantidad){
  
        var encontrado = carrito.some(function(producto) {return producto.id === id;});
if (!encontrado) {
  carrito.push({
    id:id,
    nombreProducto:nombreProducto,
    cantidadAñadido:0
  })}
  let index = carrito.findIndex(producto => producto.id === id);
  // Verificar si se encontró el objeto en el array
  if (index !== -1) {
  if(carrito[index].cantidadAñadido<cantidad){
    carrito[index].cantidadAñadido=carrito[index].cantidadAñadido+1;  
cantidadAñadido++;
    $( "#txtPopupCantidad" ).empty();
        $( "#txtPopupCantidad" ).append( document.createTextNode( cantidadAñadido ));
  }
  }
  
$.each(carrito, function(index, value) {
  content +=  carrito[index].nombreProducto;
  content +=  '<div class="row mt-2"><button onclick="agregar('+carrito[index].id+','+cantidad+')" class="btn btn-outline-warning ml-4">+</button>';
  content+='<div class="col-4 "><input type="text" value="'+carrito[index].cantidadAñadido+'" class=" text-center form-control" aria-label="Recipientusername with two button addons" aria-describedby="button-addon1" readonly></div>';
  content+='<button onclick="quitar('+carrito[index].id+','+cantidad+')" class="btn btn-outline-warning ">-</button></div>';

});
content +=  '<div class="container"><button id="btnComprar" class="btn text-white btn-block mt-3" style="background-color: #4abaa5;">comprar</button></div>';
$(popUpCarrito).attr('data-content', content);
$(popUpCarrito).popover('show');    
  }
function agregar(id,cantidad){
  const popUpCarrito = document.getElementById("popUpCarrito");
var content = '';
let index = carrito.findIndex(producto => producto.id==id);
// Verificar si se encontró el objeto en el array
if (index !== -1) {
  console.log("hola")
  if(carrito[index].cantidadAñadido<cantidad){
  carrito[index].cantidadAñadido=carrito[index].cantidadAñadido+1;
  console.log(carrito[index].cantidadAñadido)
  cantidadAñadido++;
  $( "#txtPopupCantidad" ).empty();
  $( "#txtPopupCantidad" ).append( document.createTextNode( cantidadAñadido ));
}
 }


$.each(carrito, function(index, value) {
  content +=  carrito[index].nombreProducto;
  content +=  '<div class="row mt-2"><button onclick="agregar('+carrito[index].id+','+cantidad+')" class="btn btn-outline-warning ml-4">+</button>';
  content+='<div class="col-4 "><input type="text" value="'+carrito[index].cantidadAñadido+'" class=" text-center form-control" aria-label="Recipientusername with two button addons" aria-describedby="button-addon1" readonly></div>';
  content+='<button onclick="quitar('+carrito[index].id+','+cantidad+')" class="btn btn-outline-warning ">-</button></div>';
});
content +=  '<div class="container"><button id="btnComprar" class="btn text-white btn-block mt-3" style="background-color: #4abaa5;">comprar</button></div>';
$(popUpCarrito).attr('data-content', content);
$(popUpCarrito).popover('show');


}

function quitar(id,cantidad){
  const popUpCarrito = document.getElementById("popUpCarrito");
  var content = '';
  let index = carrito.findIndex(producto => producto.id==id);
// Verificar si se encontró el objeto en el array
if (index !== -1) {
  if(carrito[index].cantidadAñadido>1){
    carrito[index].cantidadAñadido=carrito[index].cantidadAñadido-1;
  }else{
    carrito.splice(index, 1); 
  
  }
  console.log(carrito)

}
  if(cantidadAñadido>1){
    cantidadAñadido--;
 $( "#txtPopupCantidad" ).empty();
 $( "#txtPopupCantidad" ).append( document.createTextNode( cantidadAñadido ));
  }else{
    cantidadAñadido--;
   $( "#txtPopupCantidad" ).empty();
    content =  "<span class='text-white badge rounded-pill badge-notification bg-danger'>0</span> articulos añadidos";
  $("#btnComprar").remove();
  $(popUpCarrito).attr('data-content', content);
  $(popUpCarrito).popover('show');
  $(popUpCarrito).popover('refresh');
  }
 


$.each(carrito, function(index, value) {
 content +=  carrito[index].nombreProducto;
 content +=  '<div class="row mt-2"><button onclick="agregar('+carrito[index].id+','+cantidad+')" class="btn btn-outline-warning ml-4">+</button>';
 content+='<div class="col-4 "><input type="text" value="'+carrito[index].cantidadAñadido+'" class=" text-center form-control" aria-label="Recipientusername with two button addons" aria-describedby="button-addon1" readonly></div>';
 content+='<button onclick="quitar('+carrito[index].id+','+cantidad+')" class="btn btn-outline-warning ">-</button></div>';
});
content +=  '<div class="container"><button id="btnComprar" class="btn text-white btn-block mt-3" style="background-color: #4abaa5;">comprar</button></div>';
$(popUpCarrito).attr('data-content', content);
$(popUpCarrito).popover('show');


}
    </script>
{% endblock %}
